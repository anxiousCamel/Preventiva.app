<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Preventiva - Carrossel de Balanças</title>
    <style>
      /* Estilos para o container do carrossel */
      #carouselContainer {
        display: flex;
        overflow-x: scroll;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        gap: 10px;
        padding: 10px;
      }

      .slide {
        flex: 0 0 100%;
        scroll-snap-align: start;
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 15px;
        box-sizing: border-box;
        background-color: #f9f9f9;
      }

      fieldset {
        margin-bottom: 15px;
        padding: 10px;
      }

      label {
        display: block;
        margin-bottom: 5px;
      }

      input[type="text"],
      input[type="file"] {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
        box-sizing: border-box;
      }

      button {
        padding: 10px 15px;
        background-color: #007bff;
        border: none;
        color: #fff;
        border-radius: 3px;
        cursor: pointer;
      }

      /* -------------------------------------
   Gooey Checkbox Styles (de avstorm)
   ------------------------------------- */

      /* reset básico para checkbox customizado */
      input[type="checkbox"] {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        -webkit-tap-highlight-color: transparent;
        cursor: pointer;
        margin: 0;
      }

      input[type="checkbox"]:focus {
        outline: none;
      }

      /* container da bolinha */
      .cbx {
        position: relative;
        width: 24px;
        height: 24px;
        display: inline-block;
        margin-right: 8px;
      }

      /* círculo não-checked */
      .cbx input {
        position: absolute;
        top: 0;
        left: 0;
        width: 24px;
        height: 24px;
        border: 2px solid #bfbfc0;
        border-radius: 50%;
        transition: all 0.2s ease;
      }

      .cbx input:hover {
        border-color: #a9a9a9;
      }

      /* círculo “goo” por trás */
      .cbx label {
        position: absolute;
        top: 0;
        left: 0;
        width: 24px;
        height: 24px;
        background: none;
        border-radius: 50%;
        filter: url(#goo);
        transform: translate3d(0, 0, 0);
        pointer-events: none;
      }

      /* ícone de checkmark */
      .cbx svg {
        position: absolute;
        top: 5px;
        left: 4px;
        z-index: 1;
        pointer-events: none;
      }

      .cbx svg path {
        stroke: white;
        stroke-width: 3;
        stroke-linecap: round;
        stroke-linejoin: round;
        stroke-dasharray: 19;
        stroke-dashoffset: 19;
        transition: all 0.4s ease;
      }

      /* animação ao marcar */
      input[type="checkbox"]:checked + label {
        animation: splash 0.6s ease forwards;
      }

      input[type="checkbox"]:checked + label + svg path {
        stroke-dashoffset: 0;
      }

      @keyframes splash {
        0% {
          transform: scale(1.1);
        }

        40% {
          transform: scale(1);
          background: #12408f;
          box-shadow: 0 -18px 0 -8px #12408f, 16px -8px 0 -8px #12408f,
            16px 8px 0 -8px #12408f, 0 18px 0 -8px #12408f,
            -16px 8px 0 -8px #12408f, -16px -8px 0 -8px #12408f;
        }

        100% {
          background: #12408f;
          box-shadow: 0 -32px 0 -10px transparent,
            28px -16px 0 -10px transparent, 28px 16px 0 -10px transparent,
            0 32px 0 -10px transparent, -28px 16px 0 -10px transparent,
            -28px -16px 0 -10px transparent;
        }
      }
    </style>
    <!-- Biblioteca pdf-lib (versão 1.17.1) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  </head>

  <body>
    <!-- Gooey filter SVG -->
    <svg
      xmlns="http://www.w3.org/2000/svg"
      style="position: absolute; width: 0; height: 0; pointer-events: none"
    >
      <defs>
        <filter id="goo">
          <feGaussianBlur in="SourceGraphic" stdDeviation="4" result="blur" />
          <feColorMatrix
            in="blur"
            mode="matrix"
            values="1 0 0 0 0  
                0 1 0 0 0  
                0 0 1 0 0  
                0 0 0 22 -7"
            result="goo"
          />
          <feBlend in="SourceGraphic" in2="goo" />
        </filter>
      </defs>
    </svg>

    <h1>Preventiva - Carrossel de Balanças</h1>

    <!-- Container do carrossel -->
    <div id="carouselContainer"></div>

    <!-- Botão para gerar o PDF com todas as preventivas -->
    <div style="padding: 15px">
      <button type="button" onclick="generateFilledPDF()">
        Gerar PDF com todas as Preventivas
      </button>
    </div>

    <script>
      // Recupera os dados dos equipamentos armazenados no sessionStorage
      const equipamentosData = sessionStorage.getItem("equipamentosData");
      const carouselContainer = document.getElementById("carouselContainer");

      /**
       * Mostra a pré-visualização da imagem.
       * @param {HTMLInputElement} fileInput - O input de arquivo
       * @param {HTMLImageElement} previewImg - Elemento <img> para exibir a prévia
       */
      function previewImage(fileInput, previewImg) {
        const file = fileInput.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            previewImg.src = e.target.result;
            previewImg.style.display = "block";
          };
          reader.readAsDataURL(file);
        } else {
          previewImg.style.display = "none";
        }
      }

      // checklist options: idSuffix e labelText
      const CHECKLIST_OPTIONS = [
        { idSuffix: "limparCabecote", labelText: "Limpar cabeçote" },
        { idSuffix: "testeImpressao", labelText: "Teste de impressão" },
        { idSuffix: "pesoBalanca", labelText: "Peso da balança" },
        { idSuffix: "teclado", labelText: "Teclado" },
        { idSuffix: "display", labelText: "Display" },
        { idSuffix: "nivelarBalanca", labelText: "Nivelar balança" },
        { idSuffix: "cabos", labelText: "Cabos" },
        { idSuffix: "retirarAdesivo", labelText: "Retirar adesivo e outros" },
        { idSuffix: "tampas", labelText: "Tampas" },
        { idSuffix: "limpezaBalanca", labelText: "Limpeza da balança" },
      ];

      /**
       * Gera o HTML de um item do checklist com Gooey Checkbox.
       * @param {number} slideIndex – índice do slide para ID único
       * @param {string} idSuffix – sufixo único para o ID
       * @param {string} labelText – texto exibido
       * @returns {string} bloco de HTML
       */
      function createChecklistItem(slideIndex, idSuffix, labelText) {
        const fieldId = `${idSuffix}_${slideIndex}`;
        return `
          <div class="checklist-item" style="display:flex; align-items:center; margin-bottom:8px;">
            <div class="cbx">
              <input type="checkbox" id="${fieldId}" name="checklist" value="${idSuffix}">
              <label for="${fieldId}"></label>
              <svg width="15" height="14" viewBox="0 0 15 14" fill="none">
                <path d="M2 8.36364L6.23077 12L13 2" />
              </svg>
            </div>
            <label for="${fieldId}" style="user-select:none; cursor:pointer;">
              ${labelText}
            </label>
          </div>
        `;
      }

      if (equipamentosData) {
        const equipamentos = JSON.parse(equipamentosData);

        // Ordena índices por setor (alfabético)
        const sortedIndices = equipamentos
          .map((_, idx) => idx)
          .sort((a, b) => {
            const sectorA = (equipamentos[a].setor || "").toLowerCase();
            const sectorB = (equipamentos[b].setor || "").toLowerCase();
            return sectorA.localeCompare(sectorB) || a - b;
          });

        let lastSector = null;
        sortedIndices.forEach((originalIdx, sortedIdx) => {
          const equipamento = equipamentos[originalIdx];
          const thisSector = (equipamento.setor || "").toLowerCase();
          const slide = document.createElement("div");
          slide.classList.add("slide");

          const form = document.createElement("form");
          form.id = `preventiveForm_${sortedIdx}`;
          form.action = "/savePreventiva";
          form.method = "post";
          form.enctype = "multipart/form-data";

          // HTML base
          let html = `
            <fieldset>
              <legend>Dados da Balança ${sortedIdx + 1}</legend>
              <div><label for="numero_${sortedIdx}">Número:</label>
                   <input type="text" id="numero_${sortedIdx}" name="numero" readonly value="${
            equipamento.numero || ""
          }"></div>
              <div><label for="setor_${sortedIdx}">Setor:</label>
                   <input type="text" id="setor_${sortedIdx}" name="setor" readonly value="${
            equipamento.setor || ""
          }"></div>
              <div><label for="serie_${sortedIdx}">Série:</label>
                   <input type="text" id="serie_${sortedIdx}" name="serie" readonly value="${
            equipamento.serie || ""
          }"></div>
              <div><label for="patrimonio_${sortedIdx}">Patrimônio:</label>
                   <input type="text" id="patrimonio_${sortedIdx}" name="patrimonio" readonly value="${
            equipamento.patrimonio || ""
          }"></div>
            </fieldset>
    
            <fieldset>
              <legend>Fotos Antes</legend>
              <input type="file" id="fotoAntes_${sortedIdx}" name="fotoAntes" accept="image/*" capture="environment">
              <img id="previewFotoAntes_${sortedIdx}" alt="Prévia" style="max-width:100%; display:none; margin-top:10px;">
            </fieldset>
    
            <fieldset>
              <legend>Checklist</legend>
              <div style="margin-bottom:8px;">
                <label>
                  <input type="checkbox" id="checkAll_${sortedIdx}" data-slide-index="${sortedIdx}">
                  Marcar todos
                </label>
              </div>
              ${CHECKLIST_OPTIONS.map((opt) =>
                createChecklistItem(sortedIdx, opt.idSuffix, opt.labelText)
              ).join("")}
            </fieldset>

    
            <fieldset>
              <legend>Fotos Depois</legend>
              <input type="file" id="fotoDepois_${sortedIdx}" name="fotoDepois" accept="image/*" capture="environment">
              <img id="previewFotoDepois_${sortedIdx}" alt="Prévia" style="max-width:100%; display:none; margin-top:10px;">
            </fieldset>
    
            <fieldset>
              <legend>Observações</legend>
              <textarea id="observacoes_${sortedIdx}" name="observacoes" rows="4" style="width:100%;" placeholder="Digite observações..."></textarea>
            </fieldset>
          `;

          // Adiciona assinaturas apenas no primeiro slide de cada setor
          if (sortedIdx === 0 || thisSector !== lastSector) {
            html += `
              <fieldset>
                <legend>Assinatura Responsável pelo Setor</legend>
                <label for="nomeResponsavel_${sortedIdx}">Nome:</label>
                <input type="text" id="nomeResponsavel_${sortedIdx}" name="nomeResponsavel" placeholder="Nome do responsável">
                <label for="cargoResponsavel_${sortedIdx}">Cargo:</label>
                <select id="cargoResponsavel_${sortedIdx}" name="cargoResponsavel">
                  <option>Responsável de Setor</option>
                  <option>Gerente</option>
                  <option>Supervisor</option>
                </select>
                <p>Assinatura:</p>
                <canvas id="signatureCanvasResponsavel_${sortedIdx}" width="300" height="150" style="border:1px solid #ccc;"></canvas><br>
                <button type="button" onclick="clearSignature('Responsavel', ${sortedIdx})">Limpar</button>
                <input type="hidden" id="assinaturaInputResponsavel_${sortedIdx}" name="assinaturaResponsavel">
              </fieldset>
    
              <fieldset>
                <legend>Assinatura Técnico de TI</legend>
                <label for="nomeTi_${sortedIdx}">Nome:</label>
                <input type="text" id="nomeTi_${sortedIdx}" name="nomeTi" placeholder="Nome do técnico">
                <p>Assinatura:</p>
                <canvas id="signatureCanvasTi_${sortedIdx}" width="300" height="150" style="border:1px solid #ccc;"></canvas><br>
                <button type="button" onclick="clearSignature('Ti', ${sortedIdx})">Limpar</button>
                <input type="hidden" id="assinaturaInputTi_${sortedIdx}" name="assinaturaTi">
              </fieldset>
            `;
          }
          lastSector = thisSector;

          form.innerHTML = html;
          slide.appendChild(form);
          carouselContainer.appendChild(slide);

          // configura previews
          form
            .querySelector(`#fotoAntes_${sortedIdx}`)
            .addEventListener("change", (e) =>
              previewImage(
                e.target,
                form.querySelector(`#previewFotoAntes_${sortedIdx}`)
              )
            );
          form
            .querySelector(`#fotoDepois_${sortedIdx}`)
            .addEventListener("change", (e) =>
              previewImage(
                e.target,
                form.querySelector(`#previewFotoDepois_${sortedIdx}`)
              )
            );
        });
      } else {
        alert(
          "Dados do equipamento não encontrados. Inicie a preventiva novamente."
        );
      }

     // Função para marcar/desmarcar todos os checkboxes
function toggleAllCheckboxes(slideIndex) {
  const checkboxes = document.querySelectorAll(`#preventiveForm_${slideIndex} input[type="checkbox"]:not(#checkAll_${slideIndex})`);
  const checkAllCheckbox = document.getElementById(`checkAll_${slideIndex}`);

  // Verifica se todos os checkboxes estão marcados
  const allChecked = Array.from(checkboxes).every((checkbox) => checkbox.checked);

  // Marca/desmarca todos os checkboxes
  checkboxes.forEach((checkbox) => {
    checkbox.checked = !allChecked;
  });

  // Atualiza o estado do "Marcar todos"
  checkAllCheckbox.checked = !allChecked;
}

// Adiciona o evento ao "Marcar todos"
document.addEventListener('DOMContentLoaded', () => {
  const checkAllCheckboxes = document.querySelectorAll('input[type="checkbox"][id^="checkAll_"]');
  checkAllCheckboxes.forEach((checkbox) => {
    checkbox.addEventListener('click', (event) => {
      const slideIndex = event.target.getAttribute('data-slide-index');
      toggleAllCheckboxes(slideIndex);
    });
  });
});
    </script>

    <script>
      // Função para habilitar a área de assinatura em um canvas
      function enableSignatureCanvas(canvas, index, tipo) {
        const ctx = canvas.getContext("2d");
        let drawing = false;

        canvas.addEventListener("mousedown", (e) => {
          drawing = true;
          ctx.beginPath();
          ctx.moveTo(e.offsetX, e.offsetY);
        });

        canvas.addEventListener("mousemove", (e) => {
          if (!drawing) return;
          ctx.lineTo(e.offsetX, e.offsetY);
          ctx.stroke();
        });

        canvas.addEventListener("mouseup", () => (drawing = false));
        canvas.addEventListener("mouseout", () => (drawing = false));

        canvas.addEventListener("touchstart", (e) => {
          const rect = canvas.getBoundingClientRect();
          const touch = e.touches[0];
          ctx.beginPath();
          ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
          drawing = true;
        });

        canvas.addEventListener("touchmove", (e) => {
          e.preventDefault();
          const rect = canvas.getBoundingClientRect();
          const touch = e.touches[0];
          if (!drawing) return;
          ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
          ctx.stroke();
        });

        canvas.addEventListener("touchend", () => (drawing = false));

        // salvar assinatura ao submeter o formulário
        const form = document.getElementById(`preventiveForm_${index}`);
        if (form) {
          form.addEventListener("submit", () => {
            const dataURL = canvas.toDataURL();
            document.getElementById(`assinaturaInput${tipo}_${index}`).value =
              dataURL;
          });
        }
      }

      // limpa o canvas e o hidden input correspondente
      function clearSignature(role, index) {
        const canvasId = `signatureCanvas${role}_${index}`;
        const inputId = `assinaturaInput${role}_${index}`;

        const canvas = document.getElementById(canvasId);
        if (canvas) {
          const ctx = canvas.getContext("2d");
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        const input = document.getElementById(inputId);
        if (input) {
          input.value = "";
        }
      }

      // Inicializa a função de assinatura para cada canvas
      window.addEventListener("load", () => {
        const totalSlides = document.querySelectorAll("canvas").length;
        for (let i = 0; i < totalSlides; i++) {
          const canvasResponsavel = document.getElementById(
            `signatureCanvasResponsavel_${i}`
          );
          const canvasTi = document.getElementById(`signatureCanvasTi_${i}`);
          if (canvasResponsavel)
            enableSignatureCanvas(canvasResponsavel, i, "Responsavel");
          if (canvasTi) enableSignatureCanvas(canvasTi, i, "Ti");
        }
      });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script>
      /**
       * Converte um File em string Base64
       * @param {File} file
       * @returns {Promise<string>}
       */
      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = (error) => reject(error);
          reader.readAsDataURL(file);
        });
      }

      /**
       * Gera o PDF preenchido agrupando preventivas por setor (até 2 por página).
       * Se o setor mudar, sempre inicia nova página.
       */
      async function generateFilledPDF() {
        const { PDFDocument, StandardFonts } = PDFLib;

        // 1) Carrega template
        const templateUrl = "CHEK LIST PREVENTIVA BALANÇAS.pdf";
        const templateBytes = await fetch(templateUrl).then((r) =>
          r.arrayBuffer()
        );
        const pdfDoc = await PDFDocument.load(templateBytes);
        const helveticaFont = await pdfDoc.embedFont(StandardFonts.Helvetica);
        const form = pdfDoc.getForm();

        const perPage = 2;
        const deltaX = 355;

        // Pages dinâmicas: começa com uma cópia da página template
        let pages = [];
        const [firstPage] = await pdfDoc.copyPages(pdfDoc, [0]);
        pdfDoc.addPage(firstPage);
        pages.push(firstPage);

        // Helper: obtém retângulo de um campo (null se não existir)
        function getFieldRectangle(fieldName) {
          try {
            const field = form.getField(fieldName);
            const widget = field.acroField.getWidgets()[0];
            return widget.getRectangle();
          } catch {
            return null;
          }
        }

        // Desenha texto no slot da página
        function drawTextFieldDirect(page, fieldName, text, slotIndex) {
          if (!text) return;
          const rect = getFieldRectangle(fieldName);
          if (!rect) return;
          const { x, y, height } = rect;
          page.drawText(text, {
            x: x + slotIndex * deltaX,
            y: y + height - 12,
            size: 12,
            font: helveticaFont,
          });
        }

        // Desenha 'X' para checkbox
        function drawCheckboxFieldDirect(page, fieldName, checked, slotIndex) {
          if (!checked) return;
          const rect = getFieldRectangle(fieldName);
          if (!rect) return;
          const { x, y, height } = rect;
          page.drawText("X", {
            x: x + slotIndex * deltaX + 2,
            y: y + height / 2 - 4,
            size: height,
            font: helveticaFont,
          });
        }

        // Desenha imagem (antes/depois) no slot
        async function drawImageSlot(
          page,
          fieldName,
          base64WithPrefix,
          defaultPos,
          slotIndex
        ) {
          if (!base64WithPrefix) return;
          const [, data] = base64WithPrefix.split(",");
          let embedded;
          if (
            base64WithPrefix.includes("jpeg") ||
            base64WithPrefix.includes("jpg")
          ) {
            embedded = await pdfDoc.embedJpg(data);
          } else {
            embedded = await pdfDoc.embedPng(data);
          }

          let pos = defaultPos;
          const rect = getFieldRectangle(fieldName);
          if (rect) pos = rect;

          page.drawImage(embedded, {
            x: pos.x + slotIndex * deltaX,
            y: pos.y,
            width: pos.width,
            height: pos.height,
          });
        }

        // Desenha assinatura em PNG (setor ou TI)
        async function drawSignature(page, fieldName, base64Png, slotIndex) {
          if (!base64Png) return;
          const image = await pdfDoc.embedPng(base64Png);
          const field = form.getField(fieldName);
          const widget = field.acroField.getWidgets()[0];
          const { x, y, width, height } = widget.getRectangle();
          page.drawImage(image, {
            x: x + slotIndex * deltaX,
            y: y,
            width,
            height,
          });
        }

        // Recupera dados de hoje para preencher datas
        const today = new Date();
        const day = String(today.getDate()).padStart(2, "0");
        const month = String(today.getMonth() + 1).padStart(2, "0");
        const year = String(today.getFullYear());

        // Coleta todos os formulários no DOM
        const forms = Array.from(
          document.querySelectorAll("form[id^='preventiveForm_']")
        );

        // Agrupa índices por setor, mantendo ordem original
        const sectorGroups = {};
        forms.forEach((_, idx) => {
          const sector = document.getElementById(`setor_${idx}`)?.value || "";
          if (!sectorGroups[sector]) sectorGroups[sector] = [];
          sectorGroups[sector].push(idx);
        });

        // Monta sequência de índices respeitando ordem de aparição
        const orderedIndices = [];
        Object.values(sectorGroups).forEach((group) =>
          orderedIndices.push(...group)
        );

        // Variáveis de controle de página/slot
        let currentPageIndex = 0;
        let slotIndex = 0;
        let previousSector = null;

        for (const idx of orderedIndices) {
          const sectorValue =
            document.getElementById(`setor_${idx}`)?.value || "";

          // Se mudou de setor e slot atual não está vazio, inicia nova página
          if (sectorValue !== previousSector && slotIndex !== 0) {
            const [clone] = await pdfDoc.copyPages(pdfDoc, [0]);
            pdfDoc.addPage(clone);
            pages.push(clone);
            currentPageIndex = pages.length - 1;
            slotIndex = 0;
          }

          // Se slot cheio (>= perPage), inicia nova página
          if (slotIndex >= perPage) {
            const [clone] = await pdfDoc.copyPages(pdfDoc, [0]);
            pdfDoc.addPage(clone);
            pages.push(clone);
            currentPageIndex = pages.length - 1;
            slotIndex = 0;
          }

          const page = pages[currentPageIndex];

          // Valores textuais
          const numberValue =
            document.getElementById(`numero_${idx}`)?.value || "";
          const serialValue =
            document.getElementById(`serie_${idx}`)?.value || "";
          const patrimonyValue =
            document.getElementById(`patrimonio_${idx}`)?.value || "";
          const obsValue =
            document.getElementById(`observacoes_${idx}`)?.value || "";
          const nameSectorValue =
            document.getElementById(`nomeResponsavel_${idx}`)?.value || "";
          const nameTiValue =
            document.getElementById(`nomeTi_${idx}`)?.value || "";
          const roleValue =
            document.getElementById(`cargoResponsavel_${idx}`)?.value || "";

          // Desenha campos de texto
          drawTextFieldDirect(page, "equipment_number", numberValue, slotIndex);
          drawTextFieldDirect(page, "equipment_sector", sectorValue, slotIndex);
          drawTextFieldDirect(page, "equipment_serial", serialValue, slotIndex);
          drawTextFieldDirect(
            page,
            "equipment_patrimonio",
            patrimonyValue,
            slotIndex
          );
          drawTextFieldDirect(page, "equipment_obs", obsValue, slotIndex);
          drawTextFieldDirect(page, "nameSector", nameSectorValue, slotIndex);
          drawTextFieldDirect(page, "nameTi", nameTiValue, slotIndex);
          drawTextFieldDirect(page, "cargoResponsavel", roleValue, slotIndex);
          // Datas
          [
            "diaTi",
            "mesTi",
            "anoTi",
            "diaResponsavel",
            "mesResponsavel",
            "anoResponsavel",
          ].forEach((field) => {
            const text = field.includes("dia")
              ? day
              : field.includes("mes")
              ? month
              : year;
            drawTextFieldDirect(page, field, text, slotIndex);
          });

          // Checkboxes
          const checkboxes = [
            "limparCabecote",
            "testeImpressao",
            "pesoBalanca",
            "teclado",
            "display",
            "nivelarBalanca",
            "cabos",
            "retirarAdesivo",
            "tampas",
            "limpezaBalança",
          ];
          checkboxes.forEach((name) => {
            const checked = document.getElementById(
              `${name.replace(/([A-Z])/g, (m) => m)}_${idx}`
            )?.checked;
            drawCheckboxFieldDirect(
              page,
              `checkbox_${name}`,
              checked,
              slotIndex
            );
          });

          // Imagens antes/depois
          const beforeFile = document.getElementById(`fotoAntes_${idx}`)
            ?.files[0];
          const afterFile = document.getElementById(`fotoDepois_${idx}`)
            ?.files[0];
          const before64 = beforeFile ? await fileToBase64(beforeFile) : null;
          const after64 = afterFile ? await fileToBase64(afterFile) : null;
          await drawImageSlot(
            page,
            "before_cleaning",
            before64,
            { x: 50, y: 400, width: 200, height: 150 },
            slotIndex
          );
          await drawImageSlot(
            page,
            "after_cleaning",
            after64,
            { x: 300, y: 400, width: 200, height: 150 },
            slotIndex
          );

          // Assinaturas
          const canvasResp = document.getElementById(
            `signatureCanvasResponsavel_${idx}`
          );
          const canvasTi = document.getElementById(`signatureCanvasTi_${idx}`);
          const respData =
            canvasResp && canvasResp.toDataURL() !== "data:,"
              ? canvasResp.toDataURL().split(",")[1]
              : null;
          const tiData =
            canvasTi && canvasTi.toDataURL() !== "data:,"
              ? canvasTi.toDataURL().split(",")[1]
              : null;
          await drawSignature(page, "signatureSector", respData, slotIndex);
          await drawSignature(page, "signatureTi", tiData, slotIndex);

          // Atualiza controles
          slotIndex += 1;
          previousSector = sectorValue;
        }

        // Finaliza: fixa campos e dispara download
        form.flatten();
        const pdfBytes = await pdfDoc.save();
        const blob = new Blob([pdfBytes], { type: "application/pdf" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "preventivas_preenchidas.pdf";
        a.click();
      }
    </script>
  </body>
</html>
