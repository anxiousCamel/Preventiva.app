<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Preventiva - Carrossel de Balanças</title>
    <style>
      /* Estilos para o container do carrossel */
      #carouselContainer {
        display: flex;
        overflow-x: scroll;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        gap: 10px;
        padding: 10px;
      }

      .slide {
        flex: 0 0 100%;
        scroll-snap-align: start;
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 15px;
        box-sizing: border-box;
        background-color: #f9f9f9;
      }

      fieldset {
        margin-bottom: 15px;
        padding: 10px;
      }

      label {
        display: block;
        margin-bottom: 5px;
      }

      input[type="text"],
      input[type="file"] {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
        box-sizing: border-box;
      }

      button {
        padding: 10px 15px;
        background-color: #007bff;
        border: none;
        color: #fff;
        border-radius: 3px;
        cursor: pointer;
      }
    </style>
    <!-- Biblioteca pdf-lib (versão 1.17.1) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  </head>

  <body>
    <h1>Preventiva - Carrossel de Balanças</h1>

    <!-- Container do carrossel -->
    <div id="carouselContainer"></div>

    <!-- Botão para gerar o PDF com todas as preventivas -->
    <div style="padding: 15px">
      <button type="button" onclick="generateFilledPDF()">
        Gerar PDF com todas as Preventivas
      </button>
    </div>

    <script>
      // Recupera os dados dos equipamentos armazenados no sessionStorage
      const equipamentosData = sessionStorage.getItem("equipamentosData");
      const carouselContainer = document.getElementById("carouselContainer");

      /**
       * Função para mostrar a pré-visualização da imagem.
       * @param {HTMLInputElement} fileInput - O input do arquivo.
       * @param {HTMLImageElement} previewImg - A imagem onde será exibida a pré-visualização.
       */
      function previewImage(fileInput, previewImg) {
        const file = fileInput.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            previewImg.src = e.target.result;
            previewImg.style.display = "block";
          };
          reader.readAsDataURL(file);
        } else {
          previewImg.style.display = "none";
        }
      }

      // Monta os formulários (slides) se os dados existirem
      if (equipamentosData) {
        const equipamentos = JSON.parse(equipamentosData);
        equipamentos.forEach((equipamento, index) => {
          const slide = document.createElement("div");
          slide.classList.add("slide");

          const form = document.createElement("form");
          form.setAttribute("id", `preventiveForm_${index}`);
          form.setAttribute("action", "/savePreventiva");
          form.setAttribute("method", "post");
          form.setAttribute("enctype", "multipart/form-data");

          form.innerHTML = `
            <!-- Dados da Balança -->
            <fieldset>
              <legend>Dados da Balança ${index + 1}</legend>
              <div>
                <label for="numero_${index}">Número da Balança:</label>
                <input type="text" id="numero_${index}" name="numero" readonly value="${
            equipamento.numero || ""
          }">
              </div>
              <div>
                <label for="setor_${index}">Setor da Balança:</label>
                <input type="text" id="setor_${index}" name="setor" readonly value="${
            equipamento.setor || ""
          }">
              </div>
              <div>
                <label for="serie_${index}">Série da Balança:</label>
                <input type="text" id="serie_${index}" name="serie" readonly value="${
            equipamento.serie || ""
          }">
              </div>
              <div>
                <label for="patrimonio_${index}">Patrimônio da Balança:</label>
                <input type="text" id="patrimonio_${index}" name="patrimonio" readonly value="${
            equipamento.patrimonio || ""
          }">
              </div>
            </fieldset>

                        <!-- Fotos da Preventiva -->
            <fieldset>
              <legend>Fotos da Preventiva</legend>
              <div>
                <label for="fotoAntes_${index}">Foto antes da preventiva:</label>
                <input type="file" id="fotoAntes_${index}" name="fotoAntes" accept="image/*" capture="environment">
                <img id="previewFotoAntes_${index}" style="max-width:100%; display:none; margin-top:10px;" alt="Pré-visualização da foto antes">
              </div>
               </fieldset>
            
            <!-- Checklist da Preventiva -->
            <fieldset>
              <legend>Checklist da Preventiva</legend>
              <div>
                <input type="checkbox" id="limparCabecote_${index}" name="checklist" value="limparCabecote">
                <label for="limparCabecote_${index}">Limpar cabeçote</label>
              </div>
              <div>
                <input type="checkbox" id="testeImpressao_${index}" name="checklist" value="testeImpressao">
                <label for="testeImpressao_${index}">Teste de impressão</label>
              </div>
              <div>
                <input type="checkbox" id="pesoBalança_${index}" name="checklist" value="pesoBalança">
                <label for="pesoBalança_${index}">Peso da balança</label>
              </div>
              <div>
                <input type="checkbox" id="teclado_${index}" name="checklist" value="teclado">
                <label for="teclado_${index}">Teclado</label>
              </div>
              <div>
                <input type="checkbox" id="display_${index}" name="checklist" value="display">
                <label for="display_${index}">Display</label>
              </div>
              <div>
                <input type="checkbox" id="nivelarBalança_${index}" name="checklist" value="nivelarBalança">
                <label for="nivelarBalança_${index}">Nivelar balança</label>
              </div>
              <div>
                <input type="checkbox" id="cabos_${index}" name="checklist" value="cabos">
                <label for="cabos_${index}">Cabos</label>
              </div>
              <div>
                <input type="checkbox" id="retirarAdesivo_${index}" name="checklist" value="retirarAdesivo">
                <label for="retirarAdesivo_${index}">Retirar adesivo e outros</label>
              </div>
              <div>
                <input type="checkbox" id="tampas_${index}" name="checklist" value="tampas">
                <label for="tampas_${index}">Tampas</label>
              </div>
              <div>
                <input type="checkbox" id="limpezaBalança_${index}" name="checklist" value="limpezaBalança">
                <label for="limpezaBalança_${index}">Limpeza da balança</label>
              </div>
            </fieldset>
            
            <!-- Fotos da Preventiva -->
            <fieldset>
               <legend>Fotos da Preventiva</legend>
              <div>
                <label for="fotoDepois_${index}">Foto depois da preventiva:</label>
                <input type="file" id="fotoDepois_${index}" name="fotoDepois" accept="image/*" capture="environment">
                <img id="previewFotoDepois_${index}" style="max-width:100%; display:none; margin-top:10px;" alt="Pré-visualização da foto depois">
              </div>
            </fieldset>
<!-- Observações -->
<fieldset>
  <legend>Observações</legend>
  <label for="observacoes_${index}">Detalhes adicionais:</label>
  <textarea id="observacoes_${index}" name="observacoes" rows="4" style="width: 100%;" placeholder="Digite aqui observações importantes..."></textarea>
</fieldset>

<!-- Assinatura Responsável pelo Setor -->
<fieldset>
  <legend>Assinatura do Responsável pelo Setor</legend>
  
  <label for="nomeResponsavel_${index}">Nome:</label>
  <input type="text" id="nomeResponsavel_${index}" name="nomeResponsavel" placeholder="Nome do responsável pelo setor">
  
  <label for="cargoResponsavel_${index}">Cargo:</label>
  <select id="cargoResponsavel_${index}" name="cargoResponsavel">
    <option value="Responsável de Setor">Responsável de Setor</option>
    <option value="Gerente">Gerente</option>
    <option value="Supervisor">Supervisor</option>
  </select>

  <p>Assinatura:</p>
  <canvas id="signatureCanvasResponsavel_${index}" width="300" height="150" style="border:1px solid #ccc;"></canvas><br>
  <button type="button" onclick="clearSignature('Responsavel', ${index})">Limpar Assinatura</button>
  <input type="hidden" name="assinaturaResponsavel" id="assinaturaInputResponsavel_${index}">
</fieldset>

<!-- Assinatura Técnico de TI -->
<fieldset>
  <legend>Assinatura do Técnico de TI</legend>
  
  <label for="nomeTi_${index}">Nome:</label>
  <input type="text" id="nomeTi_${index}" name="nomeTi" placeholder="Nome do técnico de TI">

  <p>Assinatura:</p>
  <canvas id="signatureCanvasTi_${index}" width="300" height="150" style="border:1px solid #ccc;"></canvas><br>
  <button type="button" onclick="clearSignature('Ti', ${index})">Limpar Assinatura</button>
  <input type="hidden" name="assinaturaTi" id="assinaturaInputTi_${index}">
</fieldset>  
          `;

          slide.appendChild(form);
          carouselContainer.appendChild(slide);

          // Evento para pré-visualização das fotos
          const fotoAntesInput = form.querySelector(`#fotoAntes_${index}`);
          const previewFotoAntes = form.querySelector(
            `#previewFotoAntes_${index}`
          );
          fotoAntesInput.addEventListener("change", () =>
            previewImage(fotoAntesInput, previewFotoAntes)
          );

          const fotoDepoisInput = form.querySelector(`#fotoDepois_${index}`);
          const previewFotoDepois = form.querySelector(
            `#previewFotoDepois_${index}`
          );
          fotoDepoisInput.addEventListener("change", () =>
            previewImage(fotoDepoisInput, previewFotoDepois)
          );
        });
      } else {
        alert(
          "Dados do equipamento não encontrados. Por favor, inicie a preventiva novamente."
        );
      }
    </script>

    <script>
      // Função para habilitar a área de assinatura em um canvas
      function enableSignatureCanvas(canvas, index, tipo) {
        const ctx = canvas.getContext("2d");
        let drawing = false;

        canvas.addEventListener("mousedown", (e) => {
          drawing = true;
          ctx.beginPath();
          ctx.moveTo(e.offsetX, e.offsetY);
        });

        canvas.addEventListener("mousemove", (e) => {
          if (!drawing) return;
          ctx.lineTo(e.offsetX, e.offsetY);
          ctx.stroke();
        });

        canvas.addEventListener("mouseup", () => (drawing = false));
        canvas.addEventListener("mouseout", () => (drawing = false));

        canvas.addEventListener("touchstart", (e) => {
          const rect = canvas.getBoundingClientRect();
          const touch = e.touches[0];
          ctx.beginPath();
          ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
          drawing = true;
        });

        canvas.addEventListener("touchmove", (e) => {
          e.preventDefault();
          const rect = canvas.getBoundingClientRect();
          const touch = e.touches[0];
          if (!drawing) return;
          ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
          ctx.stroke();
        });

        canvas.addEventListener("touchend", () => (drawing = false));

        // salvar assinatura ao submeter o formulário
        const form = document.getElementById(`preventiveForm_${index}`);
        if (form) {
          form.addEventListener("submit", () => {
            const dataURL = canvas.toDataURL();
            document.getElementById(`assinaturaInput${tipo}_${index}`).value =
              dataURL;
          });
        }
      }

      // limpa o canvas e o hidden input correspondente
      function clearSignature(role, index) {
        const canvasId = `signatureCanvas${role}_${index}`;
        const inputId = `assinaturaInput${role}_${index}`;

        const canvas = document.getElementById(canvasId);
        if (canvas) {
          const ctx = canvas.getContext("2d");
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        const input = document.getElementById(inputId);
        if (input) {
          input.value = "";
        }
      }

      // Inicializa a função de assinatura para cada canvas
      window.addEventListener("load", () => {
        const totalSlides = document.querySelectorAll("canvas").length;
        for (let i = 0; i < totalSlides; i++) {
          const canvasResponsavel = document.getElementById(
            `signatureCanvasResponsavel_${i}`
          );
          const canvasTi = document.getElementById(`signatureCanvasTi_${i}`);
          if (canvasResponsavel)
            enableSignatureCanvas(canvasResponsavel, i, "Responsavel");
          if (canvasTi) enableSignatureCanvas(canvasTi, i, "Ti");
        }
      });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script>
      /**
       * Converte um File em string Base64
       * @param {File} file
       * @returns {Promise<string>}
       */
      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = (error) => reject(error);
          reader.readAsDataURL(file);
        });
      }

      /**
       * Gera o PDF preenchido com N preventivas, 2 por página.
       */
      async function generateFilledPDF() {
        const { PDFDocument, StandardFonts } = PDFLib;

        // 1) Carrega template
        const templateUrl = "CHEK LIST PREVENTIVA BALANÇAS.pdf";
        const templateBytes = await fetch(templateUrl).then((r) =>
          r.arrayBuffer()
        );
        const pdfDoc = await PDFDocument.load(templateBytes);

        // 2) Calcula quantas páginas precisa
        const equipmentCount = document.querySelectorAll(
          "form[id^='preventiveForm_']"
        ).length;
        const perPage = 2;
        const pageCount = Math.ceil(equipmentCount / perPage);
        const deltaX = 355;

        // 3) Clona páginas extras
        for (let i = 1; i < pageCount; i++) {
          const [cloned] = await pdfDoc.copyPages(pdfDoc, [0]);
          pdfDoc.addPage(cloned);
        }

        // 4) Embute fonte e form
        const helveticaFont = await pdfDoc.embedFont(StandardFonts.Helvetica);
        const form = pdfDoc.getForm();

        /**
         * Tenta obter o retângulo de um campo; retorna null se não existir.
         * @param {string} fieldName
         * @returns {{x:number,y:number,width:number,height:number}|null}
         */
        function getFieldRectangle(fieldName) {
          try {
            const f = form.getField(fieldName);
            const widget = f.acroField.getWidgets()[0];
            return widget.getRectangle();
          } catch {
            return null;
          }
        }

        /**
         * Desenha texto baseado na posição de um campo interativo.
         * @param {PDFPage} page
         * @param {string} fieldName  nome do campo no PDF
         * @param {string} text
         * @param {number} slotIndex  0 ou 1
         */
        function drawTextFieldDirect(page, fieldName, text, slotIndex) {
          if (!text) return;
          const { x, y, height } = getFieldRectangle(fieldName);
          page.drawText(text, {
            x: x + slotIndex * deltaX,
            y: y + height - 12, // ajusta baseline para caber no campo
            size: 12,
            font: helveticaFont,
          });
        }

        /**
         * Desenha um "X" para marcar um checkbox.
         * @param {PDFPage} page
         * @param {string} fieldName
         * @param {boolean} checked
         * @param {number} slotIndex
         */
        function drawCheckboxFieldDirect(page, fieldName, checked, slotIndex) {
          if (!checked) return;
          const { x, y, height } = getFieldRectangle(fieldName);
          page.drawText("X", {
            x: x + slotIndex * deltaX + 2,
            y: y + height / 2 - 4,
            size: height,
            font: helveticaFont,
          });
        }

        /**
         * Desenha imagem (antes/depois) num slot.
         * @param {PDFPage} page
         * @param {string} fieldName
         * @param {string|null} base64WithPrefix
         * @param {{x:number,y:number,width:number,height:number}} defaultPos
         * @param {number} slotIndex
         */
        async function drawImageSlot(
          page,
          fieldName,
          base64WithPrefix,
          defaultPos,
          slotIndex
        ) {
          if (!base64WithPrefix) return;
          const [prefix, data] = base64WithPrefix.split(",");
          const embedded =
            prefix.includes("jpeg") || prefix.includes("jpg")
              ? await pdfDoc.embedJpg(data)
              : await pdfDoc.embedPng(data);

          let x, y, width, height;
          try {
            const field = form.getField(fieldName);
            const widget = field.acroField.getWidgets()[0];
            ({ x, y, width, height } = widget.getRectangle());
          } catch {
            ({ x, y, width, height } = defaultPos);
          }

          page.drawImage(embedded, {
            x: x + slotIndex * deltaX,
            y,
            width,
            height,
          });
        }

        /**
         * Desenha assinatura num slot.
         * @param {PDFPage} page
         * @param {string|null} base64Data  sem prefixo
         * @param {number} slotIndex
         */
        // Desenha assinatura do setor
        async function drawSignatureSector(page, base64Png, slotIndex) {
          if (!base64Png) return;
          const image = await pdfDoc.embedPng(base64Png);

          // pega a posição do campo signatureSector e renomeia para sx, sy, sw, sh
          const field = pdfDoc.getForm().getField("signatureSector");
          const widget = field.acroField.getWidgets()[0];
          const { x: sx, y: sy, width: sw, height: sh } = widget.getRectangle();

          page.drawImage(image, {
            x: sx + slotIndex * deltaX,
            y: sy,
            width: sw,
            height: sh,
          });
        }

        // Desenha assinatura do TI
        async function drawSignatureTi(page, base64Png, slotIndex) {
          if (!base64Png) return;
          const image = await pdfDoc.embedPng(base64Png);

          const field = pdfDoc.getForm().getField("signatureTi");
          const widget = field.acroField.getWidgets()[0];
          const { x: sx, y: sy, width: sw, height: sh } = widget.getRectangle();

          page.drawImage(image, {
            x: sx + slotIndex * deltaX,
            y: sy,
            width: sw,
            height: sh,
          });
        }

        const today = new Date();
        const dia = String(today.getDate()).padStart(2, "0");
        const mes = String(today.getMonth() + 1).padStart(2, "0"); // meses começam em 0
        const ano = String(today.getFullYear());

        // 5) Loop principal
        for (let idx = 0; idx < equipmentCount; idx++) {
          const page = pdfDoc.getPages()[Math.floor(idx / perPage)];
          const slotIndex = idx % perPage;

          // lê valores do DOM
          const numberValue =
            document.getElementById(`numero_${idx}`)?.value || "";
          const sectorValue =
            document.getElementById(`setor_${idx}`)?.value || "";
          const serialValue =
            document.getElementById(`serie_${idx}`)?.value || "";
          const patrimonyValue =
            document.getElementById(`patrimonio_${idx}`)?.value || "";
          const obsValue =
            document.getElementById(`observacoes_${idx}`)?.value || "";
          const nameSectorValue =
            document.getElementById(`nomeResponsavel_${idx}`)?.value || "";
          const nameTiValue =
            document.getElementById(`nomeTi_${idx}`)?.value || "";
          const cargoResponsavelValue =
            document.getElementById(`cargoResponsavel_${idx}`)?.value || "";

          // desenha textos
          drawTextFieldDirect(page, "equipment_number", numberValue, slotIndex);
          drawTextFieldDirect(page, "equipment_sector", sectorValue, slotIndex);
          drawTextFieldDirect(page, "equipment_serial", serialValue, slotIndex);
          drawTextFieldDirect(page,"equipment_patrimonio",patrimonyValue, slotIndex);
          drawTextFieldDirect(page, "equipment_obs", obsValue, slotIndex);
          drawTextFieldDirect(page, "nameSector", nameSectorValue, slotIndex);
          drawTextFieldDirect(page, "nameTi", nameTiValue, slotIndex);
          drawTextFieldDirect(page,"cargoResponsavel", cargoResponsavelValue,slotIndex);

          // preenche campos de data automaticamente
          drawTextFieldDirect(page, "diaTi", dia, slotIndex);
          drawTextFieldDirect(page, "mesTi", mes, slotIndex);
          drawTextFieldDirect(page, "anoTi", ano, slotIndex);

          drawTextFieldDirect(page, "diaResponsavel", dia, slotIndex);
          drawTextFieldDirect(page, "mesResponsavel", mes, slotIndex);
          drawTextFieldDirect(page, "anoResponsavel", ano, slotIndex);

          // ——————————————————————————————————————————
          // 1️⃣ Pegando o estado dos demais checkboxes no HTML
          // ——————————————————————————————————————————

          // Limpar cabeçote
          const clearHeadChecked = document.getElementById(
            `limparCabecote_${idx}`
          )?.checked;
          // Teste de impressao
          const testPrintingChecked = document.getElementById(
            `testeImpressao_${idx}`
          )?.checked;
          // Peso da balança
          const weightChecked = document.getElementById(
            `pesoBalança_${idx}`
          )?.checked;
          // Teclado
          const keyboardChecked = document.getElementById(
            `teclado_${idx}`
          )?.checked;
          // Display
          const displayChecked = document.getElementById(
            `display_${idx}`
          )?.checked;
          // Nivelar balança
          const levelingChecked = document.getElementById(
            `nivelarBalança_${idx}`
          )?.checked;
          // Cabos
          const cablesChecked = document.getElementById(
            `cabos_${idx}`
          )?.checked;
          // Retirar adesivos e outros
          const removeAdhesiveChecked = document.getElementById(
            `retirarAdesivo_${idx}`
          )?.checked;
          // Tampas
          const coversChecked = document.getElementById(
            `tampas_${idx}`
          )?.checked;
          // Limpeza da balança
          const cleaningChecked = document.getElementById(
            `limpezaBalança_${idx}`
          )?.checked;

          // ——————————————————————————————————————————
          // 2️⃣ Desenhando o “X” no PDF para cada checkbox
          // ——————————————————————————————————————————
          drawCheckboxFieldDirect(
            page,
            "checkbox_limparCabecote",
            clearHeadChecked,
            slotIndex
          );
          drawCheckboxFieldDirect(
            page,
            "checkbox_testeDeImpressao",
            testPrintingChecked,
            slotIndex
          );
          drawCheckboxFieldDirect(
            page,
            "checkbox_peso",
            weightChecked,
            slotIndex
          );
          drawCheckboxFieldDirect(
            page,
            "checkbox_teclado",
            keyboardChecked,
            slotIndex
          );
          drawCheckboxFieldDirect(
            page,
            "checkbox_display",
            displayChecked,
            slotIndex
          );
          drawCheckboxFieldDirect(
            page,
            "checkbox_nivelarBalanca",
            levelingChecked,
            slotIndex
          );
          drawCheckboxFieldDirect(
            page,
            "checkbox_cabos",
            cablesChecked,
            slotIndex
          );
          drawCheckboxFieldDirect(
            page,
            "checkbox_retirarAdesivos",
            removeAdhesiveChecked,
            slotIndex
          );
          drawCheckboxFieldDirect(
            page,
            "checkbox_tampas",
            coversChecked,
            slotIndex
          );
          drawCheckboxFieldDirect(
            page,
            "checkbox_limpezaBalanca",
            cleaningChecked,
            slotIndex
          );

          // imagens
          const beforeFile = document.getElementById(`fotoAntes_${idx}`)
            ?.files[0];
          const afterFile = document.getElementById(`fotoDepois_${idx}`)
            ?.files[0];
          const before64 = beforeFile ? await fileToBase64(beforeFile) : null;
          const after64 = afterFile ? await fileToBase64(afterFile) : null;

          await drawImageSlot(
            page,
            "before_cleaning",
            before64,
            { x: 50, y: 400, width: 200, height: 150 },
            slotIndex
          );
          await drawImageSlot(
            page,
            "after_cleaning",
            after64,
            { x: 300, y: 400, width: 200, height: 150 },
            slotIndex
          );

          // assinatura
          const canvasResp = document.getElementById(
            `signatureCanvasResponsavel_${idx}`
          );
          const canvasTi = document.getElementById(`signatureCanvasTi_${idx}`);

          let sigRespData = null;
          if (canvasResp) {
            const dataURL = canvasResp.toDataURL();
            if (dataURL !== "data:,") sigRespData = dataURL.split(",")[1];
          }

          let sigTiData = null;
          if (canvasTi) {
            const dataURL = canvasTi.toDataURL();
            if (dataURL !== "data:,") sigTiData = dataURL.split(",")[1];
          }

          // assinatura Responsável
          await drawSignatureSector(page, sigRespData, slotIndex);
          // assinatura TI
          await drawSignatureTi(page, sigTiData, slotIndex);
        }

        // 6) Flatten para fixar tudo e evitar sobreposição de campos em branco
        form.flatten();

        // 7) Salva e dispara download
        const pdfBytes = await pdfDoc.save();
        const blob = new Blob([pdfBytes], { type: "application/pdf" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "preventivas_preenchidas.pdf";
        a.click();
      }
    </script>
  </body>
</html>
